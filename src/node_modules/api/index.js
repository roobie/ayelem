const xtend = require('xtend')

const _ = require('lodash')

const crud = (initialData = []) => {
  const data = initialData.slice(0)

  return {
    list: (predicate) => new Promise((resolve, reject) => {
      resolve(data.filter(predicate || (x => x)))
    }),
    single: (predicate) => new Promise((resolve, reject) => {
      const item = data.filter(predicate)[0]
      if (item) {
        resolve(item)
      } else {
        reject(new Error('not found'))
      }
    }),
    create: (model) => new Promise((resolve, reject) => {
      data.push(model)
      resolve()
    }),
    update: (id, model) => new Promise((resolve, reject) => {
      if (!data[id]) {
        reject(new Error('not found'))
      } else {
        data[id] = model
        resolve()
      }
    }),
    patch: (id, partial) => new Promise((resolve, reject) => {
      if (!data[id]) {
        reject(new Error('not found'))
      } else {
        xtend(data[id], partial)
        resolve()
      }
    }),
    delete: (id) => new Promise((resolve, reject) => {
      if (!data[id]) {
        reject(new Error('not found'))
      } else {
        data.splice(id, 1, null)
        resolve()
      }
    })
  }
}

const random = {
  name: (n) => _.range(0, n || 1).map(_ => String.fromCharCode(Math.ceil(0xff / 4) + 1 + Math.floor(Math.random() * 26))).join(''),
  Date: () => new Date(new Date().valueOf() - Math.floor(Math.random() * 0xffffffff))
}

module.exports = {
  systems: crud(_.range(0, 50).map(_ => {
    return {
      title: `Sys_${random.name(2)}`,
      created: random.Date().toLocaleString()
    }
  }))
}
